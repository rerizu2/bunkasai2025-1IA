<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>背面カメラ → QRコード生成</title>
<style>
body {
  font-family: "Noto Sans JP", sans-serif;
  background: #f8fafc;
  color: #1e293b;
  text-align: center;
  padding: 20px;
}
h1 { color: #2563eb; }
video, img {
  width: 90%;
  max-width: 400px;
  border-radius: 10px;
  margin: 10px auto;
  display: block;
  background: #e2e8f0;
}
button {
  padding: 10px 16px;
  margin: 5px;
  border: none;
  border-radius: 8px;
  background: #2563eb;
  color: white;
  cursor: pointer;
  font-size: 1rem;
}
button:disabled { opacity: 0.5; cursor: not-allowed; }
#qrcode {
  margin-top: 20px;
  background: white;
  display: inline-block;
  padding: 10px;
  border-radius: 12px;
  border: 1px solid #ccc;
}
</style>
</head>
<body>

<h1>📷 背面カメラ → QRコード生成</h1>

<video id="preview" autoplay playsinline muted></video>
<img id="photoPreview" alt="撮影結果" />
<div>
  <button id="startCam">🎥 カメラ起動（外カメ）</button>
  <button id="takePhoto" disabled>📸 撮影</button>
  <button id="stopCam" disabled>🛑 停止</button>
</div>

<h2>生成されたQRコード</h2>
<div id="qrcode"></div>
<p id="status"></p>

<!-- QRコードライブラリ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
        integrity="sha512-VxR0aKjE+RcC3WqXwc0Oe7PZDnLOm0O/ImfMfeDhnm1cLrIXJ81ZbnC2Z9khx5p3PuX7EMK2Xvfb2zR3w5x2DQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
const startCamBtn = document.getElementById("startCam");
const takePhotoBtn = document.getElementById("takePhoto");
const stopCamBtn = document.getElementById("stopCam");
const preview = document.getElementById("preview");
const photoPreview = document.getElementById("photoPreview");
const qrcodeDiv = document.getElementById("qrcode");
const statusP = document.getElementById("status");
let stream = null;
const canvas = document.createElement("canvas");

// === カメラ起動（背面） ===
startCamBtn.onclick = async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } }, audio: false
    });
  } catch {
    stream = await navigator.mediaDevices.getUserMedia({ video: true });
  }
  preview.srcObject = stream;
  takePhotoBtn.disabled = false;
  stopCamBtn.disabled = false;
  statusP.textContent = "✅ カメラ起動しました";
};

// === 撮影 ===
takePhotoBtn.onclick = () => {
  if (!stream) return alert("カメラが起動していません。");
  const w = preview.videoWidth;
  const h = preview.videoHeight;
  const thumbW = 200;
  const thumbH = Math.round(h / w * thumbW);

  canvas.width = thumbW;
  canvas.height = thumbH;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(preview, 0, 0, thumbW, thumbH);
  const smallData = canvas.toDataURL("image/jpeg", 0.6);

  photoPreview.src = smallData;
  makeQr(smallData);
};

// === 停止 ===
stopCamBtn.onclick = () => {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  takePhotoBtn.disabled = true;
  stopCamBtn.disabled = true;
  statusP.textContent = "🛑 カメラ停止";
};

// === QRコード生成 ===
function makeQr(dataUrl) {
  qrcodeDiv.innerHTML = "";
  try {
    const html = `
<!doctype html><html><meta charset='utf-8'>
<body style='text-align:center;font-family:sans-serif'>
<h3>📸 撮影画像</h3>
<img src='${dataUrl}' style='max-width:90%;border-radius:8px;border:1px solid #ccc;'>
</body></html>`;
    const qrData = "data:text/html," + encodeURIComponent(html);

    new QRCode(qrcodeDiv, {
      text: qrData,
      width: 260,
      height: 260,
      correctLevel: QRCode.CorrectLevel.L
    });

    statusP.textContent = "✅ QRコード生成完了！";
  } catch (err) {
    statusP.textContent = "❌ QRコード生成に失敗しました：" + err;
    console.error(err);
  }
}
</script>
</body>
</html>
