<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>èƒŒé¢ã‚«ãƒ¡ãƒ© â†’ QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</title>
<style>
body {
  font-family: "Noto Sans JP", sans-serif;
  background: #f8fafc;
  color: #1e293b;
  text-align: center;
  padding: 20px;
}
h1 { color: #2563eb; }
video, img {
  width: 90%;
  max-width: 400px;
  border-radius: 10px;
  margin: 10px auto;
  display: block;
  background: #e2e8f0;
}
button {
  padding: 10px 16px;
  margin: 5px;
  border: none;
  border-radius: 8px;
  background: #2563eb;
  color: white;
  cursor: pointer;
  font-size: 1rem;
}
button:disabled { opacity: 0.5; cursor: not-allowed; }
#qrcode {
  margin-top: 20px;
  background: white;
  display: inline-block;
  padding: 10px;
  border-radius: 12px;
  border: 1px solid #ccc;
}
</style>
</head>
<body>

<h1>ğŸ“· èƒŒé¢ã‚«ãƒ¡ãƒ© â†’ QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</h1>

<video id="preview" autoplay playsinline muted></video>
<img id="photoPreview" alt="æ’®å½±çµæœ" />
<div>
  <button id="startCam">ğŸ¥ ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆå¤–ã‚«ãƒ¡ï¼‰</button>
  <button id="takePhoto" disabled>ğŸ“¸ æ’®å½±</button>
  <button id="stopCam" disabled>ğŸ›‘ åœæ­¢</button>
</div>

<h2>ç”Ÿæˆã•ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰</h2>
<div id="qrcode"></div>
<p id="status"></p>

<!-- QRã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
        integrity="sha512-VxR0aKjE+RcC3WqXwc0Oe7PZDnLOm0O/ImfMfeDhnm1cLrIXJ81ZbnC2Z9khx5p3PuX7EMK2Xvfb2zR3w5x2DQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
const startCamBtn = document.getElementById("startCam");
const takePhotoBtn = document.getElementById("takePhoto");
const stopCamBtn = document.getElementById("stopCam");
const preview = document.getElementById("preview");
const photoPreview = document.getElementById("photoPreview");
const qrcodeDiv = document.getElementById("qrcode");
const statusP = document.getElementById("status");
let stream = null;
const canvas = document.createElement("canvas");

// === ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆèƒŒé¢ï¼‰ ===
startCamBtn.onclick = async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } }, audio: false
    });
  } catch {
    stream = await navigator.mediaDevices.getUserMedia({ video: true });
  }
  preview.srcObject = stream;
  takePhotoBtn.disabled = false;
  stopCamBtn.disabled = false;
  statusP.textContent = "âœ… ã‚«ãƒ¡ãƒ©èµ·å‹•ã—ã¾ã—ãŸ";
};

// === æ’®å½± ===
takePhotoBtn.onclick = () => {
  if (!stream) return alert("ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚");
  const w = preview.videoWidth;
  const h = preview.videoHeight;
  const thumbW = 200;
  const thumbH = Math.round(h / w * thumbW);

  canvas.width = thumbW;
  canvas.height = thumbH;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(preview, 0, 0, thumbW, thumbH);
  const smallData = canvas.toDataURL("image/jpeg", 0.6);

  photoPreview.src = smallData;
  makeQr(smallData);
};

// === åœæ­¢ ===
stopCamBtn.onclick = () => {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  takePhotoBtn.disabled = true;
  stopCamBtn.disabled = true;
  statusP.textContent = "ğŸ›‘ ã‚«ãƒ¡ãƒ©åœæ­¢";
};

// === QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ ===
function makeQr(dataUrl) {
  qrcodeDiv.innerHTML = "";
  try {
    const html = `
<!doctype html><html><meta charset='utf-8'>
<body style='text-align:center;font-family:sans-serif'>
<h3>ğŸ“¸ æ’®å½±ç”»åƒ</h3>
<img src='${dataUrl}' style='max-width:90%;border-radius:8px;border:1px solid #ccc;'>
</body></html>`;
    const qrData = "data:text/html," + encodeURIComponent(html);

    new QRCode(qrcodeDiv, {
      text: qrData,
      width: 260,
      height: 260,
      correctLevel: QRCode.CorrectLevel.L
    });

    statusP.textContent = "âœ… QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†ï¼";
  } catch (err) {
    statusP.textContent = "âŒ QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + err;
    console.error(err);
  }
}
</script>
</body>
</html>
